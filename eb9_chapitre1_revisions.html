<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Évaluation Finale | Académie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap');
        body { font-family: 'Quicksand', sans-serif; background-color: #f0f7ff; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 85px; background: white; display: flex; flex-direction: column; align-items: center; padding: 25px 0; border-right: 1px solid #eef2f6; }
        .logo-dragon { width: 48px; height: 48px; background: #2c3e50; border-radius: 14px; display: flex; align-items: center; justify-content: center; color: white; font-size: 22px; margin-bottom: 40px; cursor:pointer; }
        .main-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
        .game-card { background: white; border-radius: 35px; padding: 35px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); width: 100%; max-width: 750px; }
        
        .opt-btn { width: 100%; padding: 15px; margin-bottom: 10px; border: 2px solid #f1f5f9; border-radius: 18px; text-align: left; font-weight: 600; transition: 0.2s; cursor: pointer; color: #475569; }
        .opt-btn:hover:not(:disabled) { background: #f8fafc; border-color: #2980b9; transform: translateX(5px); }
        
        .correct { background: #d1fae5 !important; color: #065f46 !important; border-color: #10b981 !important; }
        .wrong { background: #fee2e2 !important; color: #991b1b !important; border-color: #ef4444 !important; }
        
        #playerNameInput { background-color: #f1f5f9 !important; border: 2px solid #cbd5e1 !important; }
    </style>
</head>
<body>
    <nav class="sidebar">
        <div class="logo-dragon" onclick="window.location.href='index.html'"><i class="fas fa-dragon"></i></div>
        <div class="text-slate-300 hover:text-blue-500 cursor-pointer" onclick="window.location.href='index.html'"><i class="fas fa-home text-2xl"></i></div>
    </nav>

    <main class="main-content">
        <div class="game-card">
            
            <div id="start-zone" class="text-center">
                <div class="w-20 h-20 bg-slate-100 text-slate-700 rounded-3xl flex items-center justify-center text-3xl mx-auto mb-6">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <h2 class="text-3xl font-black text-slate-800 mb-2">Grand Examen Final</h2>
                <p class="text-slate-500 mb-8 px-10">50 questions pour prouver ta maîtrise du français. Ton score sera enregistré sur 100 points.</p>
                
                <div class="max-w-xs mx-auto">
                    <input type="text" id="playerNameInput" placeholder="Ton Prénom" class="w-full p-4 rounded-2xl mb-4 text-center font-bold text-lg outline-none">
                    <button onclick="preStart()" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-slate-900 transition-all">LANCER L'ÉVALUATION</button>
                </div>
            </div>

            <div id="quiz-ui" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <span id="progress" class="bg-slate-100 text-slate-600 px-4 py-1 rounded-full text-xs font-bold uppercase tracking-widest">Question 1 / 50</span>
                    </div>
                    <div class="text-right">
                        <p class="text-slate-400 text-[10px] font-bold uppercase">Score actuel</p>
                        <p id="score-display" class="text-2xl font-black text-blue-600">0</p>
                    </div>
                </div>

                <h3 id="q-text" class="text-xl font-bold text-slate-800 mb-6 leading-tight"></h3>
                <div id="options" class="space-y-3"></div>
                
                <div id="feedback" class="mt-6 p-4 rounded-2xl text-sm hidden border-l-8"></div>
                
                <button id="next-btn" class="hidden w-full mt-6 bg-blue-600 text-white py-4 rounded-2xl font-bold hover:bg-blue-700 transition">QUESTION SUIVANTE &rarr;</button>
            </div>

            <div id="final-screen" class="hidden text-center">
                <h2 class="text-3xl font-black text-slate-800 mb-2">Examen Terminé !</h2>
                <p class="text-slate-500 mb-6">Ton score final a été envoyé au Leaderboard.</p>
                <div class="text-6xl font-black text-blue-600 mb-8" id="final-score">0 / 50</div>
                
                <div class="flex flex-col gap-3">
                    <button onclick="window.location.href='index.html'" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold">RETOUR ACCUEIL</button>
                    <button id="btn-fix-errors" onclick="retryErrors()" class="w-full bg-green-500 text-white py-4 rounded-2xl font-bold hidden">REVOIR MES ERREURS</button>
                </div>
            </div>

        </div>
    </main>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbys_uz58mt03TDr5gthhtJIeZJqqJDTuikaHwUa60o2rp3S4jIOeuABIrjWyfUDuhEdLg/exec";
        
        const allQuestions = [
            // Tes questions (tronquées ici pour l'exemple mais à garder complètes dans ton fichier)
            { q: "Nature de 'Gratuitement' ?", o: ["Adjectif", "Adverbe", "Nom"], r: 1, e: "Modifie le verbe fournir." },
            { q: "Nature de 'À' ?", o: ["Article", "Préposition", "Pronom"], r: 1, e: "C'est une préposition." },
            { q: "Nature de 'Qui' dans 'L'organisation qui...' ?", o: ["Pronom relatif", "Pronom personnel", "Conjonction"], r: 0, e: "Introduit une relative." },
            { q: "Fonction de 'Connexion' dans 'fournir une connexion' ?", o: ["Sujet", "COD", "COI"], r: 1, e: "Répond à 'fournir quoi ?'." },
            { q: "Nature de 'Dès que' ?", o: ["Coordination", "Subordination", "Adverbe"], r: 1, e: "Introduit une subordonnée de temps." },
            { q: "Nature de 'Du' dans 'la fin du jour' ?", o: ["Article défini", "Article contracté", "Préposition"], r: 1, e: "Du = de + le." },
            { q: "Nature de 'Mais' ?", o: ["Coordination", "Subordination", "Adjectif"], r: 0, e: "Mais, ou, et, donc, or, ni, car." },
            { q: "Nature de 'Certains' dans 'Certains élèves' ?", o: ["Pronom", "Déterminant indéfini", "Adverbe"], r: 1, e: "Détermine le nom élèves." },
            { q: "Nature de 'En' dans 'Grâce à en' ?", o: ["Préposition", "Pronom personnel COI", "Article"], r: 1, e: "Remplace un nom." },
            { q: "Fonction de 'Américaine' dans 'organisation américaine' ?", o: ["Attribut", "Épithète", "Apposition"], r: 1, e: "Placé juste après le nom." },
            { q: "Lequel est un verbe d'état ?", o: ["Chercher", "Se tenir", "Écrire"], r: 1, e: "Indique une manière d'être." },
            { q: "Lequel est un verbe de pensée ?", o: ["S'habiller", "Savoir", "Entendre"], r: 1, e: "Activité intellectuelle." },
            { q: "Lequel est un verbe d'action ?", o: ["Connaître", "Rougir", "Écrire"], r: 2, e: "Action concrète." },
            { q: "Groupe du verbe 'Aller' ?", o: ["1er", "2e", "3e"], r: 2, e: "Irrégulier malgré sa fin en -er." },
            { q: "Groupe du verbe 'Finir' (nous finissons) ?", o: ["1er", "2e", "3e"], r: 1, e: "Finit en -ir et fait -issant." },
            { q: "Groupe du verbe 'Mourir' ?", o: ["2e", "3e", "1er"], r: 1, e: "Verbe irrégulier du 3e groupe." },
            { q: "Mode de 'En écrivant' ?", o: ["Infinitif", "Gérondif", "Participe"], r: 1, e: "En + participe présent." },
            { q: "Mode de 'Être signalées' ?", o: ["Indicatif", "Infinitif", "Impératif"], r: 1, e: "Infinitif présent passif." },
            { q: "Verbe 'Rougir' est un verbe...", o: ["Action", "État", "Pensée"], r: 1, e: "Exprime un changement d'état." },
            { q: "Mode de 'Saches' dans 'Il faut que tu saches' ?", o: ["Indicatif", "Subjonctif", "Conditionnel"], r: 1, e: "Obligatoire après 'il faut que'." },
            { q: "Présent : 'Je (résoudre)' ?", o: ["résouds", "résous", "résolve"], r: 1, e: "Perd son 'd'." },
            { q: "Présent : 'Nous (éteindre)' ?", o: ["éteindons", "éteignons", "éteingnons"], r: 1, e: "Prend 'gn' au pluriel." },
            { q: "Présent : 'Il (appeler)' ?", o: ["appèle", "appelle", "appele"], r: 1, e: "Double 'l' devant 'e' muet." },
            { q: "Présent : 'Tu (jeter)' ?", o: ["jètes", "jettes", "jetes"], r: 1, e: "Double 't' devant 'e' muet." },
            { q: "Présent : 'Il (essuyer)' ?", o: ["essuye", "essuie", "essuis"], r: 1, e: "y -> i devant 'e' muet." },
            { q: "Temps de 'Ils eurent fait' ?", o: ["Passé simple", "Passé antérieur", "Plus-que-parfait"], r: 1, e: "Auxiliaire passé simple + PP." },
            { q: "Temps de 'Elle fut accusée' ?", o: ["Imparfait", "Passé simple passif", "Passé composé"], r: 1, e: "Auxiliaire être passé simple + PP." },
            { q: "Temps de 'Je suis née' ?", o: ["Présent", "Passé composé", "Imparfait"], r: 1, e: "Naître au passé composé." },
            { q: "Temps de 'Il avait préparé' ?", o: ["Plus-que-parfait", "Passé composé", "Futur"], r: 0, e: "Auxiliaire imparfait + PP." },
            { q: "Futur de 'Savoir' (Je) ?", o: ["savrai", "saurai", "saurais"], r: 1, e: "Radical en aur-." },
            { q: "Préfixe de 'Impossibilité' ?", o: ["Im-", "Possible", "-ité"], r: 0, e: "Indique la négation." },
            { q: "Suffixe de 'Indomptable' ?", o: ["In-", "Dompt", "-able"], r: 2, e: "Indique la possibilité." },
            { q: "Radical de 'Renversement' ?", o: ["Re-", "Verser", "-ment"], r: 1, e: "Vient du verbe verser." },
            { q: "Nature de 'Indomptable' ?", o: ["Nom", "Adjectif", "Verbe"], r: 1, e: "Qualifie un nom." },
            { q: "Défaut de celui qui se croit supérieur ?", o: ["Hypocrite", "Arrogant", "Maniaque"], r: 1, e: "L'arrogance." },
            { q: "Contraire de 'Pessimiste' ?", o: ["Optimiste", "Idéaliste", "Ambitieux"], r: 0, e: "Voit le bon côté." },
            { q: "Qualité de celui qui est discret ?", o: ["Violent", "Indifférent", "Sincère"], r: 2, e: "Lié à la franchise." },
            { q: "Sens de 'Viscosité' ?", o: ["Solidité", "Résistance d'un fluide", "Vitesse"], r: 1, e: "Comme le miel ou l'huile." },
            { q: "Adjectif de 'Ambition' ?", o: ["Ambitiel", "Ambitieux", "Ambité"], r: 1, e: "Fait partie de la même famille." },
            { q: "Sens de 'Indocilité' ?", o: ["Obéissance", "Désobéissance", "Douceur"], r: 1, e: "Refus d'être docile." },
            { q: "Pacte autobiographique : qui doit être identique ?", o: ["Auteur/Narrateur/Personnage", "Auteur/Lecteur", "Héros/Méchant"], r: 0, e: "C'est la base du genre." },
            { q: "Discours indirect : Il dit : 'Je viens'.", o: ["Il dit qu'il vient.", "Il dit de venir.", "Il demande s'il vient."], r: 0, e: "Utilise 'que'." },
            { q: "Type de phrase : 'Où as-tu acheté ta robe ?'", o: ["Déclarative", "Interrogative", "Injonctive"], r: 1, e: "Pose une question." },
            { q: "Type de texte d'une recette ?", o: ["Narratif", "Injonctif", "Descriptif"], r: 1, e: "Donne des ordres/conseils." },
            { q: "Discours indirect : 'Est-ce que tu viendras ?'", o: ["Elle demande si je viendrai.", "Elle demande que je vienne.", "Elle dit de venir."], r: 0, e: "Est-ce que -> Si." },
            { q: "Valeur de l'imparfait dans une description ?", o: ["Action brève", "Arrière-plan", "Futur proche"], r: 1, e: "Sert à poser le décor." },
            { q: "Conjonction de coordination marquant l'opposition ?", o: ["Et", "Mais", "Donc"], r: 1, e: "Indique un contraste." },
            { q: "Le 'Pacte' est un contrat de...", o: ["Fiction", "Vérité", "Mensonge"], r: 1, e: "L'auteur promet de ne pas mentir." },
            { q: "Nature de 'Sauf' ?", o: ["Préposition", "Adverbe", "Nom"], r: 0, e: "Introduit une exception." },
            { q: "Participe passé de 'Naître' ?", o: ["Naissu", "Né", "Nait"], r: 1, e: "S'accorde avec être." }
        ];

        let currentQuestions = [...allQuestions];
        let currentIndex = 0;
        let score = 0;
        let pseudo = "";
        let errorIndices = [];

        function preStart() {
            const input = document.getElementById('playerNameInput');
            if(input.value.trim().length < 2) return alert("Entre ton prénom !");
            pseudo = input.value.trim();
            document.getElementById('start-zone').classList.add('hidden');
            document.getElementById('quiz-ui').classList.remove('hidden');
            loadQuestion();
        }

        function loadQuestion() {
            const data = currentQuestions[currentIndex];
            document.getElementById('progress').innerText = `Question ${currentIndex + 1} / ${currentQuestions.length}`;
            document.getElementById('score-display').innerText = score;
            document.getElementById('q-text').innerText = data.q;
            
            const feedback = document.getElementById('feedback');
            feedback.classList.add('hidden');
            document.getElementById('next-btn').classList.add('hidden');
            
            const box = document.getElementById('options');
            box.innerHTML = "";
            data.o.forEach((opt, i) => {
                const b = document.createElement('button');
                b.className = "opt-btn";
                b.innerText = opt;
                b.onclick = () => check(i, b);
                box.appendChild(b);
            });
        }

        function check(idx, clickedBtn) {
            const data = currentQuestions[currentIndex];
            const buttons = document.getElementsByClassName('opt-btn');
            for(let b of buttons) b.disabled = true;

            const f = document.getElementById('feedback');
            f.classList.remove('hidden');
            
            if(idx === data.r) {
                score++;
                clickedBtn.classList.add('correct');
                f.className = "mt-6 p-4 rounded-2xl text-sm border-l-8 bg-green-50 text-green-700 border-green-500";
                f.innerHTML = "<b>Excellent !</b> " + data.e;
            } else {
                clickedBtn.classList.add('wrong');
                if (!errorIndices.includes(data)) errorIndices.push(data);
                f.className = "mt-6 p-4 rounded-2xl text-sm border-l-8 bg-red-50 text-red-700 border-red-500";
                f.innerHTML = "<b>Attention...</b> La réponse était : " + data.o[data.r] + ".<br>" + data.e;
            }
            document.getElementById('next-btn').classList.remove('hidden');
        }

        document.getElementById('next-btn').onclick = () => {
            currentIndex++;
            if(currentIndex < currentQuestions.length) loadQuestion();
            else showFinal();
        };

        async function showFinal() {
            document.getElementById('quiz-ui').classList.add('hidden');
            document.getElementById('final-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = `${score} / ${currentQuestions.length}`;
            
            if (errorIndices.length > 0) document.getElementById('btn-fix-errors').classList.remove('hidden');

            // Envoi du score (Multiplié par 2 pour avoir une note sur 100)
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        nom: pseudo,
                        score: score * 2,
                        quiz: "Examen Final"
                    })
                });
            } catch (e) { console.error(e); }
        }

        function retryErrors() {
            currentQuestions = [...errorIndices];
            currentIndex = 0;
            score = 0;
            errorIndices = [];
            document.getElementById('quiz-ui').classList.remove('hidden');
            document.getElementById('final-screen').classList.add('hidden');
            loadQuestion();
        }
    </script>
</body>
</html>
