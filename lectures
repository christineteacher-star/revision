<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecteur DELF - Correction Phon√©tique Avanc√©e</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap');
        body { font-family: 'Quicksand', sans-serif; background: #f8fafc; }
        .word { font-size: 1.8rem; margin: 0 5px; color: #cbd5e1; transition: all 0.3s; display: inline-block; cursor: pointer; border-radius: 8px; padding: 2px 4px; }
        .word.current { color: #3b82f6; font-weight: 700; background: #eff6ff; border-bottom: 4px solid #3b82f6; }
        .word.read { color: #10b981; font-weight: 700; } /* Vert: Succ√®s */
        .word.skipped { color: #ef4444; font-weight: 700; text-decoration: underline; } /* Rouge: √âchec/Pass√© */
        .word.blocked { color: #f59e0b; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-5xl mx-auto bg-white rounded-3xl shadow-2xl p-6 border border-slate-200">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-black text-slate-800 tracking-tight">LECTEUR INTERACTIF EXPERT</h1>
            <p class="text-slate-500">G√©rez les terminaisons muettes. Apr√®s 3 essais, le syst√®me vous montre l'exemple.</p>
        </header>

        <div class="flex flex-wrap justify-center gap-2 mb-8">
            <button onclick="loadLevel('A1')" class="px-4 py-2 bg-slate-100 rounded-xl font-bold hover:bg-slate-200 transition">A1</button>
            <button onclick="loadLevel('B1')" class="px-4 py-2 bg-slate-100 rounded-xl font-bold hover:bg-slate-200 transition">B1</button>
            <button onclick="loadLevel('C1')" class="px-4 py-2 bg-slate-100 rounded-xl font-bold hover:bg-slate-200 transition">C1</button>
        </div>

        <div id="text-zone" class="bg-slate-50 rounded-2xl p-10 flex flex-wrap justify-center items-center text-center leading-[3.5rem] min-h-[300px]"></div>

        <div id="help-container" class="mt-6 h-24 flex flex-col items-center justify-center">
            <div id="help-message" class="hidden bg-amber-50 border-l-4 border-amber-400 p-4 rounded-r-xl shadow-sm text-amber-800 text-sm max-w-md"></div>
        </div>

        <div class="mt-4 flex flex-col items-center gap-4">
            <div class="flex gap-4">
                <button id="mic-toggle" onclick="toggleSpeech()" class="w-20 h-20 bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center text-3xl hover:bg-blue-700 transition-all">
                    <i class="fas fa-microphone" id="mic-icon"></i>
                </button>
                <button onclick="listenToWord()" class="w-16 h-16 bg-slate-800 text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-slate-900 transition-all">
                    <i class="fas fa-volume-up"></i>
                </button>
            </div>
            <div id="status" class="text-xs font-bold uppercase text-slate-400">Cliquez sur le micro (Utilisez Chrome/Edge)</div>
            <div id="attempts" class="text-sm font-bold text-blue-500">Essais : 0/3</div>
        </div>
    </div>

    <script>
        const texts = {
            'A1': "Ils mangent du pain. Le chat attend sous le petit lit blanc. Ils parlent beaucoup.",
            'B1': "Les touristes arrivent souvent tard. Ils ach√®tent des v√™tements mais ils ne comprennent pas tout.",
            'C1': "Les scientifiques soutiennent que ces ph√©nom√®nes surviennent brusquement."
        };

        const grammarRules = [
            { regex: /ent$/, help: "üí° R√®gle : Le '-ent' final des verbes au pluriel est MUET !" },
            { regex: /[stdx]$/, help: "üí° Aide : La consonne finale (-s, -t, -d, -x) est souvent muette." }
        ];

        let currentIdx = 0;
        let words = [];
        let recognition;
        let isActive = false;
        let attempts = 0;
        const synth = window.speechSynthesis;

        // Initialisation Reconnaissance Vocale
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(Speech) {
            recognition = new Speech();
            recognition.lang = 'fr-FR';
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onresult = (e) => {
                let heard = Array.from(e.results).slice(e.resultIndex)
                                 .map(res => res[0].transcript).join('').toLowerCase();
                evaluate(heard);
            };

            recognition.onerror = (e) => {
                console.log("Erreur reconnaissance:", e.error);
                if(e.error === 'not-allowed') alert("Veuillez autoriser le micro et utiliser HTTPS.");
            };

            recognition.onend = () => { if(isActive) recognition.start(); };
        }

        function loadLevel(lvl) {
            words = texts[lvl].split(/\s+/);
            currentIdx = 0;
            attempts = 0;
            updateAttemptsUI();
            const zone = document.getElementById('text-zone');
            zone.innerHTML = '';
            words.forEach((w, i) => {
                const s = document.createElement('span');
                s.id = 'wd-' + i;
                s.className = 'word';
                s.innerText = w;
                zone.appendChild(s);
            });
            updateFocus();
        }

        function updateFocus() {
            document.getElementById('help-message').classList.add('hidden');
            document.querySelectorAll('.word').forEach(s => s.classList.remove('current', 'blocked'));
            
            const c = document.getElementById('wd-' + currentIdx);
            if(c) {
                c.classList.add('current');
                c.scrollIntoView({behavior: "smooth", block: "center"});
            }
        }

        function evaluate(said) {
            if(currentIdx >= words.length) return;

            let target = words[currentIdx].toLowerCase().replace(/[.,!?;:]/g, "").normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            let cleanSaid = said.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            
            // On v√©rifie si le mot cible est pr√©sent dans la phrase entendue
            if(cleanSaid.includes(target)) {
                document.getElementById('wd-' + currentIdx).classList.add('read');
                moveToNext();
            } else {
                // On incr√©mente les tentatives si on d√©tecte une fin de mot (espace ou pause)
                // Note : La reconnaissance vocale peut √™tre capricieuse ici.
            }
        }

        function moveToNext() {
            attempts = 0;
            updateAttemptsUI();
            currentIdx++;
            if(currentIdx < words.length) updateFocus();
            else {
                document.getElementById('status').innerText = "Termin√© ! Bravo.";
                toggleSpeech();
            }
        }

        function skipWord() {
            const el = document.getElementById('wd-' + currentIdx);
            el.classList.add('skipped'); // Devient rouge
            
            // Bloquer la reconnaissance pendant la lecture audio
            if(isActive) recognition.stop();
            
            listenToWord(); // Prononciation correcte forc√©e

            setTimeout(() => {
                moveToNext();
                if(isActive) recognition.start();
            }, 1500);
        }

        function listenToWord() {
            if(currentIdx < words.length) {
                const utterance = new SpeechSynthesisUtterance(words[currentIdx]);
                utterance.lang = 'fr-FR';
                utterance.rate = 0.7;
                synth.speak(utterance);
                
                // Si on utilise le bouton manuellement, on compte √ßa comme un essai aid√©
                attempts++;
                updateAttemptsUI();
                checkAttempts();
            }
        }

        function updateAttemptsUI() {
            document.getElementById('attempts').innerText = `Essais : ${attempts}/3`;
        }

        function checkAttempts() {
            if(attempts >= 3) {
                showHelp(words[currentIdx]);
                setTimeout(() => {
                    skipWord();
                }, 2000);
            }
        }

        function showHelp(word) {
            const cleanWord = word.toLowerCase().replace(/[.,!?;]/g, "");
            let message = "üëÇ √âcoute bien la prononciation correcte...";
            for (let rule of grammarRules) {
                if (rule.regex.test(cleanWord)) {
                    message = rule.help;
                    break;
                }
            }
            const helpEl = document.getElementById('help-message');
            helpEl.innerHTML = message;
            helpEl.classList.remove('hidden');
        }

        function toggleSpeech() {
            if(!isActive) {
                recognition.start();
                isActive = true;
                document.getElementById('mic-toggle').classList.replace('bg-blue-600', 'bg-red-500');
                document.getElementById('status').innerText = "Je vous √©coute...";
            } else {
                recognition.stop();
                isActive = false;
                document.getElementById('mic-toggle').classList.replace('bg-red-500', 'bg-blue-600');
                document.getElementById('status').innerText = "Pause";
            }
        }

        loadLevel('A1');
    </script>
</body>
</html>
