<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecteur DELF Pro - Correction 3 Essais</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap');
        body { font-family: 'Quicksand', sans-serif; background: #f1f5f9; }
        .word { font-size: 1.5rem; margin: 0 4px; color: #94a3b8; transition: all 0.2s; display: inline-block; border-radius: 6px; padding: 0 4px; line-height: 2.8rem; }
        .word.current { color: #3b82f6 !important; font-weight: 700; background: #dbeafe; border-bottom: 3px solid #3b82f6; }
        .word.read { color: #10b981 !important; font-weight: 600; }
        .word.skipped { color: #ef4444 !important; text-decoration: line-through; opacity: 0.6; font-weight: 700; }
    </style>
</head>
<body class="p-4">

    <div class="max-w-5xl mx-auto bg-white rounded-3xl shadow-xl p-6 border border-slate-200">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-black text-slate-800 tracking-tight">LECTEUR DELF / DALF</h1>
            <p class="text-slate-500 text-sm">Prononcez les mots ou cliquez 3 fois sur ðŸ”Š pour passer un mot difficile.</p>
        </header>

        <div class="flex flex-wrap justify-center gap-2 mb-6">
            <button onclick="loadLevel('A1')" class="px-4 py-2 bg-slate-100 rounded-lg font-bold hover:bg-blue-600 hover:text-white transition">A1</button>
            <button onclick="loadLevel('A2')" class="px-4 py-2 bg-slate-100 rounded-lg font-bold hover:bg-blue-600 hover:text-white transition">A2</button>
            <button onclick="loadLevel('B1')" class="px-4 py-2 bg-slate-100 rounded-lg font-bold hover:bg-blue-600 hover:text-white transition">B1</button>
            <button onclick="loadLevel('B2')" class="px-4 py-2 bg-slate-100 rounded-lg font-bold hover:bg-blue-600 hover:text-white transition">B2</button>
            <button onclick="loadLevel('C1')" class="px-4 py-2 bg-slate-100 rounded-lg font-bold hover:bg-blue-600 hover:text-white transition">C1</button>
            <button onclick="loadLevel('C2')" class="px-4 py-2 bg-slate-100 rounded-lg font-bold hover:bg-blue-600 hover:text-white transition">C2</button>
        </div>

        <div id="text-zone" class="bg-slate-50 rounded-2xl p-8 text-justify min-h-[300px]"></div>

        <div class="mt-8 flex flex-col items-center gap-4">
            <div id="attempts-badge" class="bg-orange-100 text-orange-700 px-6 py-2 rounded-full text-lg font-bold shadow-sm">
                Essais sur ce mot : <span id="count-val">0</span>/3
            </div>
            
            <div class="flex gap-6">
                <button id="mic-toggle" onclick="toggleSpeech()" class="w-16 h-16 bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center text-2xl">
                    <i class="fas fa-microphone" id="mic-icon"></i>
                </button>
                <button onclick="forceSkipAfter3()" class="w-16 h-16 bg-slate-800 text-white rounded-full shadow-lg flex items-center justify-center text-2xl">
                    <i class="fas fa-volume-up"></i>
                </button>
            </div>
            <p id="status" class="text-xs font-bold uppercase text-slate-400">Micro Ã©teint</p>
        </div>
    </div>

    <script>
        const texts = {
            'A1': "Ils mangent du pain. Le chat attend sous le petit lit blanc. Ils parlent beaucoup. Elles regardent la tÃ©lÃ©vision le soir. Thomas habite Ã  Paris avec sa famille. Ils aiment le sport.",
            'A2': "Hier, nous sommes allÃ©s au marchÃ©. Ils ont achetÃ© des fruits frais. Les enfants jouent dans le jardin. Elles finissent leurs devoirs avant de sortir. Il faisait froid dehors.",
            'B1': "Le tÃ©lÃ©travail est devenu trÃ¨s populaire ces derniÃ¨res annÃ©es. De nombreux employÃ©s apprÃ©cient la flexibilitÃ© que cela offre. Ils travaillent depuis chez eux et Ã©vitent les embouteillages quotidiens. Cependant, certains trouvent difficile de sÃ©parer la vie professionnelle de la vie privÃ©e.",
            'B2': "La protection de l'environnement est l'un des enjeux majeurs de notre siÃ¨cle. Face au changement climatique, les citoyens adoptent des comportements plus responsables. On observe une rÃ©duction de la consommation de plastique.",
            'C1': "Les scientifiques soutiennent des thÃ¨ses innovantes. Ils considÃ¨rent que les algorithmes influencent nos choix. Les chercheurs parviennent Ã  des conclusions surprenantes.",
            'C2': "L'hermÃ©neutique de la traduction exige une Ã©rudition profonde. Les auteurs traduisent la pensÃ©e plus que les mots. Ils apprÃ©hendent les non-dits inhÃ©rents Ã  l'Å“uvre."
        };

        let words = [];
        let currentIdx = 0;
        let attempts = 0;
        let isActive = false;
        let recognition;
        const synth = window.speechSynthesis;

        if (window.SpeechRecognition || window.webkitSpeechRecognition) {
            const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new Speech();
            recognition.lang = 'fr-FR';
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.onresult = (e) => {
                let heard = Array.from(e.results).slice(e.resultIndex).map(res => res[0].transcript).join('').toLowerCase();
                evaluate(heard);
            };
            recognition.onend = () => { if(isActive) recognition.start(); };
        }

        function loadLevel(lvl) {
            words = texts[lvl].split(/\s+/);
            currentIdx = 0;
            attempts = 0;
            const zone = document.getElementById('text-zone');
            zone.innerHTML = '';
            words.forEach((w, i) => {
                const s = document.createElement('span');
                s.id = 'wd-' + i;
                s.className = 'word';
                s.innerText = w;
                zone.appendChild(s);
            });
            updateFocus();
        }

        function updateFocus() {
            document.querySelectorAll('.word').forEach(s => s.classList.remove('current'));
            const c = document.getElementById('wd-' + currentIdx);
            if (c) {
                c.classList.add('current');
                c.scrollIntoView({behavior: "smooth", block: "center"});
            }
            document.getElementById('count-val').innerText = attempts;
        }

        function evaluate(said) {
            if (currentIdx >= words.length) return;
            let target = words[currentIdx].toLowerCase().replace(/[.,!?;:]/g, "").normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            let heardArray = said.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").split(/\s+/);
            let lastHeard = heardArray.slice(-2); 

            let isMatch = lastHeard.some(word => {
                if (word === target) return true;
                if ((target === "ils" || target === "elles") && word === target.slice(0, -1)) return true;
                if (target.endsWith("ent") && target.length > 4) {
                    if (word === target.slice(0, -3) || word === target.slice(0, -2)) return true;
                }
                return false;
            });

            if (isMatch) {
                document.getElementById('wd-' + currentIdx).classList.add('read');
                moveToNext();
            }
        }

        // --- LA FONCTION CRITIQUE QUI DOIT MARCHER ---
        function forceSkipAfter3() {
            if (currentIdx >= words.length) return;

            // 1. Lire le mot Ã  voix haute
            const utterance = new SpeechSynthesisUtterance(words[currentIdx]);
            utterance.lang = 'fr-FR';
            synth.speak(utterance);

            // 2. Augmenter le compteur
            attempts++;
            
            // 3. VÃ©rifier si on a atteint 3
            if (attempts >= 3) {
                const el = document.getElementById('wd-' + currentIdx);
                el.classList.add('skipped'); // Le mot devient ROUGE
                
                // On attend une seconde pour que l'Ã©lÃ¨ve voie le rouge, puis on passe
                setTimeout(() => {
                    moveToNext();
                }, 1000);
            } else {
                updateFocus(); // Met Ã  jour le chiffre 1/3, 2/3...
            }
        }

        function moveToNext() {
            attempts = 0;
            currentIdx++;
            updateFocus();
            if (currentIdx === words.length) document.getElementById('status').innerText = "TerminÃ© !";
        }

        function toggleSpeech() {
            if (!isActive) {
                recognition.start();
                isActive = true;
                document.getElementById('mic-toggle').classList.replace('bg-blue-600', 'bg-red-500');
            } else {
                recognition.stop();
                isActive = false;
                document.getElementById('mic-toggle').classList.replace('bg-red-500', 'bg-blue-600');
            }
        }
        loadLevel('A1');
    </script>
</body>
</html>
