<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecteur DELF - Correction PhonÃ©tique</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap');
        body { font-family: 'Quicksand', sans-serif; background: #f8fafc; }
        .word { font-size: 1.8rem; margin: 0 5px; color: #cbd5e1; transition: all 0.3s; display: inline-block; cursor: pointer; border-radius: 8px; padding: 2px 4px; }
        .word.current { color: #3b82f6; font-weight: 700; background: #eff6ff; border-bottom: 4px solid #3b82f6; }
        .word.read { color: #10b981 !important; font-weight: 700; }
        .word.skipped { color: #ef4444 !important; text-decoration: line-through; } /* ROUGE SI PASSÃ‰ */
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-5xl mx-auto bg-white rounded-3xl shadow-2xl p-6 border border-slate-200">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-black text-slate-800">LECTEUR INTERACTIF</h1>
            <p id="status-msg" class="text-slate-500">Dites "Ils mangent". AprÃ¨s 3 clics sur le ðŸ”Š, le mot devient rouge et passe.</p>
        </header>

        <div id="text-zone" class="bg-slate-50 rounded-2xl p-10 flex flex-wrap justify-center items-center text-center leading-[3.5rem] min-h-[250px]"></div>

        <div class="mt-4 flex flex-col items-center gap-4">
            <div id="attempts-badge" class="bg-blue-100 text-blue-700 px-4 py-1 rounded-full text-sm font-bold">Essais : 0/3</div>
            <div class="flex gap-4">
                <button id="mic-toggle" onclick="toggleSpeech()" class="w-20 h-20 bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center text-3xl">
                    <i class="fas fa-microphone" id="mic-icon"></i>
                </button>
                <button onclick="handleManualHelp()" class="w-16 h-16 bg-slate-800 text-white rounded-full shadow-lg flex items-center justify-center text-2xl">
                    <i class="fas fa-volume-up"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        const textToRead = "Ils mangent du pain.";
        let words = textToRead.split(/\s+/);
        let currentIdx = 0;
        let attempts = 0; // COMPTEUR D'ESSAIS
        let isActive = false;
        let recognition;
        const synth = window.speechSynthesis;

        // 1. Initialisation de la reconnaissance
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (Speech) {
            recognition = new Speech();
            recognition.lang = 'fr-FR';
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onresult = (e) => {
                let heard = Array.from(e.results).slice(e.resultIndex)
                                 .map(res => res[0].transcript).join('').toLowerCase();
                evaluate(heard);
            };
        }

        // 2. Affichage des mots
        function init() {
            const zone = document.getElementById('text-zone');
            words.forEach((w, i) => {
                const s = document.createElement('span');
                s.id = 'wd-' + i;
                s.className = 'word';
                s.innerText = w;
                zone.appendChild(s);
            });
            updateFocus();
        }

        function updateFocus() {
            document.querySelectorAll('.word').forEach(s => s.classList.remove('current'));
            const c = document.getElementById('wd-' + currentIdx);
            if (c) c.classList.add('current');
            document.getElementById('attempts-badge').innerText = `Essais : ${attempts}/3`;
        }

        // 3. Logique de validation (avec correction pour les muettes)
        function evaluate(said) {
            if (currentIdx >= words.length) return;

            let target = words[currentIdx].toLowerCase().replace(/[.,!?;:]/g, "");
            let heard = said.toLowerCase();

            // TOLÃ‰RANCE : On accepte "il" pour "ils" et "mange" pour "mangent"
            let isMatch = heard.includes(target);
            
            // Si le mot est "ils", on accepte si l'IA entend "il"
            if (!isMatch && target === "ils" && heard.includes("il")) isMatch = true;
            
            // Si le mot est "mangent", on accepte si l'IA entend "mange"
            if (!isMatch && target === "mangent" && heard.includes("mange")) isMatch = true;

            if (isMatch) {
                document.getElementById('wd-' + currentIdx).classList.add('read');
                moveToNext();
            }
        }

        // 4. Gestion du bouton d'aide (3 clics = Rouge + Passage)
        function handleManualHelp() {
            if (currentIdx >= words.length) return;

            // Faire prononcer le mot
            const utterance = new SpeechSynthesisUtterance(words[currentIdx]);
            utterance.lang = 'fr-FR';
            synth.speak(utterance);

            // Augmenter les essais
            attempts++;

            if (attempts >= 3) {
                // Marquer en ROUGE
                const el = document.getElementById('wd-' + currentIdx);
                el.classList.add('skipped'); 
                
                // Petit dÃ©lai avant de passer
                setTimeout(() => {
                    moveToNext();
                }, 800);
            } else {
                updateFocus();
            }
        }

        function moveToNext() {
            attempts = 0;
            currentIdx++;
            updateFocus();
            if (currentIdx === words.length) {
                document.getElementById('status-msg').innerText = "FÃ©licitations ! Lecture terminÃ©e.";
            }
        }

        function toggleSpeech() {
            if (!isActive) {
                recognition.start();
                isActive = true;
                document.getElementById('mic-toggle').classList.replace('bg-blue-600', 'bg-red-500');
            } else {
                recognition.stop();
                isActive = false;
                document.getElementById('mic-toggle').classList.replace('bg-red-500', 'bg-blue-600');
            }
        }

        init();
    </script>
</body>
</html>
