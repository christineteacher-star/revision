<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecteur DELF/DALF Progressif</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap');
        body { font-family: 'Quicksand', sans-serif; background: #f1f5f9; }
        .word { font-size: 1.5rem; margin: 0 4px; color: #94a3b8; transition: all 0.2s; display: inline-block; border-radius: 6px; padding: 0 4px; line-height: 2.5rem; }
        .word.current { color: #3b82f6; font-weight: 700; background: #dbeafe; border-bottom: 3px solid #3b82f6; }
        .word.read { color: #10b981 !important; font-weight: 600; }
        .word.skipped { color: #ef4444 !important; text-decoration: line-through; opacity: 0.6; }
        #text-zone { max-height: 500px; overflow-y: auto; scroll-behavior: smooth; }
    </style>
</head>
<body class="p-4">

    <div class="max-w-5xl mx-auto bg-white rounded-3xl shadow-xl p-6 border border-slate-200">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-black text-slate-800">ENTRAÃŽNEMENT DELF / DALF</h1>
            <p class="text-slate-500 text-sm">Prononcez les mots. Si un mot bloque, cliquez 3 fois sur ðŸ”Š pour le passer en rouge.</p>
        </header>

        <div class="flex flex-wrap justify-center gap-2 mb-6">
            <button onclick="loadLevel('A1')" class="px-4 py-2 bg-slate-100 rounded-lg font-bold hover:bg-blue-600 hover:text-white transition">A1</button>
            <button onclick="loadLevel('A2')" class="px-4 py-2 bg-slate-100 rounded-lg font-bold hover:bg-blue-600 hover:text-white transition">A2</button>
            <button onclick="loadLevel('B1')" class="px-4 py-2 bg-slate-100 rounded-lg font-bold hover:bg-blue-600 hover:text-white transition">B1</button>
            <button onclick="loadLevel('B2')" class="px-4 py-2 bg-slate-100 rounded-lg font-bold hover:bg-blue-600 hover:text-white transition">B2</button>
            <button onclick="loadLevel('C1')" class="px-4 py-2 bg-slate-100 rounded-lg font-bold hover:bg-blue-600 hover:text-white transition">C1</button>
            <button onclick="loadLevel('C2')" class="px-4 py-2 bg-slate-100 rounded-lg font-bold hover:bg-blue-600 hover:text-white transition">C2</button>
        </div>

        <div id="text-zone" class="bg-slate-50 rounded-2xl p-8 text-justify min-h-[300px]"></div>

        <div class="mt-8 flex flex-col items-center gap-4">
            <div id="attempts-badge" class="bg-blue-100 text-blue-700 px-4 py-1 rounded-full text-sm font-bold">Essais : 0/3</div>
            
            <div class="flex gap-6">
                <button id="mic-toggle" onclick="toggleSpeech()" class="w-16 h-16 bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:scale-105 transition">
                    <i class="fas fa-microphone" id="mic-icon"></i>
                </button>
                <button onclick="handleManualHelp()" class="w-16 h-16 bg-slate-800 text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:scale-105 transition">
                    <i class="fas fa-volume-up"></i>
                </button>
            </div>
            <p id="status" class="text-xs font-bold uppercase text-slate-400 tracking-widest">Cliquez sur le micro pour commencer</p>
        </div>
    </div>

    <script>
        const texts = {
            'A1': "Bonjour ! Je m'appelle Thomas. J'habite Ã  Paris avec ma famille. J'aime beaucoup le sport et la musique. Le samedi, je vais au marchÃ©. J'achÃ¨te des pommes, du pain et du fromage. Le soir, nous mangeons ensemble dans la cuisine. Ils mangent souvent de la soupe. Le chat attend sous la table. C'est une belle journÃ©e ensoleillÃ©e.",
            'A2': "Hier, je suis allÃ© au cinÃ©ma avec mes amis. Nous avons vu un film d'aventure trÃ¨s intÃ©ressant. AprÃ¨s le film, nous avons mangÃ© dans un petit restaurant italien. J'ai pris des pÃ¢tes et une glace au chocolat. Il faisait un peu froid dehors, mais nous Ã©tions heureux. Demain, j'irai rendre visite Ã  mes grands-parents Ã  la campagne. Ils habitent dans une ancienne ferme avec un grand jardin fleuri.",
            'B1': "Le tÃ©lÃ©travail est devenu trÃ¨s populaire ces derniÃ¨res annÃ©es. De nombreux employÃ©s apprÃ©cient la flexibilitÃ© que cela offre. Ils travaillent depuis chez eux et Ã©vitent les embouteillages quotidiens. Cependant, certains trouvent difficile de sÃ©parer la vie professionnelle de la vie privÃ©e. Il est important de garder un rythme rÃ©gulier et de faire des pauses. Les entreprises doivent s'adapter Ã  cette nouvelle organisation pour maintenir la cohÃ©sion des Ã©quipes.",
            'B2': "La protection de l'environnement est l'un des enjeux majeurs de notre siÃ¨cle. Face au changement climatique, les citoyens adoptent des comportements plus responsables. On observe une rÃ©duction de la consommation de plastique et un engouement pour les Ã©nergies renouvelables. Les gouvernements signent des accords internationaux pour limiter les Ã©missions de gaz Ã  effet de serre. MalgrÃ© ces efforts, la transition Ã©cologique reste lente et complexe Ã  mettre en Å“uvre globalement.",
            'C1': "L'intelligence artificielle suscite autant de fascination que d'inquiÃ©tudes au sein de la sociÃ©tÃ© contemporaine. Ses partisans soulignent son potentiel rÃ©volutionnaire dans le domaine mÃ©dical ou technologique. Ã€ l'inverse, ses dÃ©tracteurs craignent une dÃ©shumanisation du travail et des dÃ©rives Ã©thiques incontrÃ´lables. Il convient donc d'Ã©tablir un cadre juridique rigoureux pour encadrer ces algorithmes. La rÃ©flexion philosophique doit accompagner chaque innovation technique pour garantir le respect des libertÃ©s individuelles.",
            'C2': "L'hermÃ©neutique de la traduction repose sur une dialectique complexe entre fidÃ©litÃ© au texte source et adaptation aux paradigmes de la langue cible. Traduire n'est point un simple exercice de transposition lexicale, mais une vÃ©ritable rÃ©Ã©criture ancrÃ©e dans une altÃ©ritÃ© culturelle. Le traducteur se doit d'apprÃ©hender les non-dits, les subtilitÃ©s stylistiques et la charge Ã©motionnelle inhÃ©rente Ã  l'Å“uvre originale. Cette quÃªte d'Ã©quivalence dynamique exige une Ã©rudition profonde et une sensibilitÃ© littÃ©raire hors du commun, afin de ne pas trahir l'Ã¢me du texte."
        };

        let words = [];
        let currentIdx = 0;
        let attempts = 0;
        let isActive = false;
        let recognition;
        const synth = window.speechSynthesis;

        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (Speech) {
            recognition = new Speech();
            recognition.lang = 'fr-FR';
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onresult = (e) => {
                let heard = Array.from(e.results).slice(e.resultIndex)
                                 .map(res => res[0].transcript).join('').toLowerCase();
                evaluate(heard);
            };
            recognition.onend = () => { if(isActive) recognition.start(); };
        }

        function loadLevel(lvl) {
            words = texts[lvl].split(/\s+/);
            currentIdx = 0;
            attempts = 0;
            const zone = document.getElementById('text-zone');
            zone.innerHTML = '';
            words.forEach((w, i) => {
                const s = document.createElement('span');
                s.id = 'wd-' + i;
                s.className = 'word';
                s.innerText = w;
                zone.appendChild(s);
            });
            updateFocus();
        }

        function updateFocus() {
            document.querySelectorAll('.word').forEach(s => s.classList.remove('current'));
            const c = document.getElementById('wd-' + currentIdx);
            if (c) {
                c.classList.add('current');
                c.scrollIntoView({behavior: "smooth", block: "center"});
            }
            document.getElementById('attempts-badge').innerText = `Essais : ${attempts}/3`;
        }

        function evaluate(said) {
            if (currentIdx >= words.length) return;

            let target = words[currentIdx].toLowerCase().replace(/[.,!?;:]/g, "").normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            
            // ANALYSE MOT Ã€ MOT : On ne prend que les 2 derniers mots prononcÃ©s
            let heardArray = said.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").split(/\s+/);
            let recentSpeech = heardArray.slice(-2); 

            let isMatch = recentSpeech.some(word => {
                // 1. Match exact
                if (word === target) return true;
                // 2. TolÃ©rance pluriels muets (Ils/Il)
                if ((target === "ils" || target === "elles") && word === target.slice(0, -1)) return true;
                // 3. TolÃ©rance verbes muets (mangent/mange)
                if (target.endsWith("ent") && word === target.slice(0, -3)) return true;
                return false;
            });

            if (isMatch) {
                document.getElementById('wd-' + currentIdx).classList.add('read');
                moveToNext();
            }
        }

        function handleManualHelp() {
            if (currentIdx >= words.length) return;

            const utterance = new SpeechSynthesisUtterance(words[currentIdx]);
            utterance.lang = 'fr-FR';
            utterance.rate = 0.8;
            synth.speak(utterance);

            attempts++;
            if (attempts >= 3) {
                const el = document.getElementById('wd-' + currentIdx);
                el.classList.add('skipped'); 
                setTimeout(() => { moveToNext(); }, 800);
            } else {
                updateFocus();
            }
        }

        function moveToNext() {
            attempts = 0;
            currentIdx++;
            updateFocus();
            if (currentIdx === words.length) {
                document.getElementById('status').innerText = "FÃ©licitations ! Niveau terminÃ©.";
            }
        }

        function toggleSpeech() {
            if (!isActive) {
                recognition.start();
                isActive = true;
                document.getElementById('mic-toggle').classList.replace('bg-blue-600', 'bg-red-500');
                document.getElementById('status').innerText = "Je vous Ã©coute...";
            } else {
                recognition.stop();
                isActive = false;
                document.getElementById('mic-toggle').classList.replace('bg-red-500', 'bg-blue-600');
                document.getElementById('status').innerText = "Pause";
            }
        }

        loadLevel('A1'); // Charge A1 au dÃ©marrage
    </script>
</body>
</html>
